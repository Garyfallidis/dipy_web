{"parents": [], "prev": null, "next": null, "title": "Particle Filtering Tractography", "meta": {}, "body": "<div class=\"section\" id=\"particle-filtering-tractography\">\n<span id=\"example-particle-filtering-fiber-tracking\"></span><h1>Particle Filtering Tractography<a class=\"headerlink\" href=\"#particle-filtering-tractography\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>Particle Filtering Tractography (PFT) <a class=\"reference internal\" href=\"#girard2014\" id=\"id1\">[Girard2014]</a> uses tissue partial\nvolume estimation (PVE) to reconstruct trajectories connecting the gray matter,\nand not incorrectly stopping in the white matter or in the corticospinal fluid.\nIt relies on a tissue classifier that identifies the tissue where the\nstreamline stopped. If the streamline correctly stopped in the gray matter, the\ntrajectory is kept. If the streamline incorrecly stopped in the white matter or\nin the corticospinal fluid, PFT uses anatomical information to find an\nalternative streamline segment to extend the trajectory. When this segment is\nfound, the tractography continues until the streamline correctly stops in the\ngray matter.</p>\n<p>PFT finds an alternative streamline segment whenever the tissue classifier\nreturns a position classified as \u2018INVALIDPOINT\u2019.</p>\n<p>This example is an extension of the\n<span class=\"xref std std-ref\">probabilistic_fiber_tracking</span> example. We begin by loading the\ndata, fitting a Constrained Spherical Deconvolution (CSD) reconstruction\nmodel and creating the probabilistic direction getter.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"k\">import</span> <span class=\"p\">(</span><span class=\"n\">read_stanford_labels</span><span class=\"p\">,</span> <span class=\"n\">default_sphere</span><span class=\"p\">,</span>\n                       <span class=\"n\">read_stanford_pve_maps</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.direction</span> <span class=\"k\">import</span> <span class=\"n\">ProbabilisticDirectionGetter</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.trackvis</span> <span class=\"k\">import</span> <span class=\"n\">save_trk</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.csdeconv</span> <span class=\"k\">import</span> <span class=\"p\">(</span><span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">,</span>\n                                   <span class=\"n\">auto_response</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.local</span> <span class=\"k\">import</span> <span class=\"n\">LocalTracking</span><span class=\"p\">,</span> <span class=\"n\">ParticleFilteringTracking</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking</span> <span class=\"k\">import</span> <span class=\"n\">utils</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"k\">import</span> <span class=\"n\">window</span><span class=\"p\">,</span> <span class=\"n\">actor</span><span class=\"p\">,</span> <span class=\"n\">colormap</span> <span class=\"k\">as</span> <span class=\"n\">cmap</span>\n\n\n<span class=\"n\">renderer</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Renderer</span><span class=\"p\">()</span>\n\n<span class=\"n\">img_pve_csf</span><span class=\"p\">,</span> <span class=\"n\">img_pve_gm</span><span class=\"p\">,</span> <span class=\"n\">img_pve_wm</span> <span class=\"o\">=</span> <span class=\"n\">read_stanford_pve_maps</span><span class=\"p\">()</span>\n<span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">labels_img</span> <span class=\"o\">=</span> <span class=\"n\">read_stanford_labels</span><span class=\"p\">()</span>\n\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">hardi_img</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">()</span>\n<span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"n\">labels_img</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">()</span>\n<span class=\"n\">affine</span> <span class=\"o\">=</span> <span class=\"n\">hardi_img</span><span class=\"o\">.</span><span class=\"n\">affine</span>\n<span class=\"n\">shape</span> <span class=\"o\">=</span> <span class=\"n\">labels</span><span class=\"o\">.</span><span class=\"n\">shape</span>\n\n<span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">ratio</span> <span class=\"o\">=</span> <span class=\"n\">auto_response</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">roi_radius</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"n\">fa_thr</span><span class=\"o\">=</span><span class=\"mf\">0.7</span><span class=\"p\">)</span>\n<span class=\"n\">csd_model</span> <span class=\"o\">=</span> <span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">)</span>\n<span class=\"n\">csd_fit</span> <span class=\"o\">=</span> <span class=\"n\">csd_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">img_pve_wm</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">())</span>\n\n<span class=\"n\">dg</span> <span class=\"o\">=</span> <span class=\"n\">ProbabilisticDirectionGetter</span><span class=\"o\">.</span><span class=\"n\">from_shcoeff</span><span class=\"p\">(</span><span class=\"n\">csd_fit</span><span class=\"o\">.</span><span class=\"n\">shm_coeff</span><span class=\"p\">,</span>\n                                               <span class=\"n\">max_angle</span><span class=\"o\">=</span><span class=\"mf\">20.</span><span class=\"p\">,</span>\n                                               <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">default_sphere</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"section\" id=\"cmc-act-tissue-classifiers\">\n<h2>CMC/ACT Tissue Classifiers<a class=\"headerlink\" href=\"#cmc-act-tissue-classifiers\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<p>Continuous map criterion (CMC) <a class=\"reference internal\" href=\"#girard2014\" id=\"id2\">[Girard2014]</a> and Anatomically-constrained\ntractography (ACT) <a class=\"reference internal\" href=\"../tracking_tissue_classifier/#smith2012\" id=\"id3\">[Smith2012]</a> both uses PVEs information from\nanatomical images to determine when the tractography stops.\nBoth tissue classifiers use a trilinear interpolation\nat the tracking position. CMC tissue classifier uses a probability derived from\nthe PVE maps to determine if the streamline reaches a \u2018valid\u2019 or \u2018invalid\u2019\nregion. ACT uses a fixed threshold on the PVE maps. Both tissue classifiers can\nbe used in conjunction with PFT. In this example, we used CMC.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.local</span> <span class=\"k\">import</span> <span class=\"n\">CmcTissueClassifier</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.streamline</span> <span class=\"k\">import</span> <span class=\"n\">Streamlines</span>\n\n<span class=\"n\">voxel_size</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">average</span><span class=\"p\">(</span><span class=\"n\">img_pve_wm</span><span class=\"o\">.</span><span class=\"n\">get_header</span><span class=\"p\">()[</span><span class=\"s1\">&#39;pixdim&#39;</span><span class=\"p\">][</span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"mi\">4</span><span class=\"p\">])</span>\n<span class=\"n\">step_size</span> <span class=\"o\">=</span> <span class=\"mf\">0.2</span>\n\n<span class=\"n\">cmc_classifier</span> <span class=\"o\">=</span> <span class=\"n\">CmcTissueClassifier</span><span class=\"o\">.</span><span class=\"n\">from_pve</span><span class=\"p\">(</span><span class=\"n\">img_pve_wm</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">(),</span>\n                                              <span class=\"n\">img_pve_gm</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">(),</span>\n                                              <span class=\"n\">img_pve_csf</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">(),</span>\n                                              <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"n\">step_size</span><span class=\"p\">,</span>\n                                              <span class=\"n\">average_voxel_size</span><span class=\"o\">=</span><span class=\"n\">voxel_size</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># seeds are place in voxel of the corpus callosum containing only white matter</span>\n<span class=\"n\">seed_mask</span> <span class=\"o\">=</span> <span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">2</span>\n<span class=\"n\">seed_mask</span><span class=\"p\">[</span><span class=\"n\">img_pve_wm</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">()</span> <span class=\"o\">&lt;</span> <span class=\"mf\">0.5</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"n\">seeds</span> <span class=\"o\">=</span> <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">seeds_from_mask</span><span class=\"p\">(</span><span class=\"n\">seed_mask</span><span class=\"p\">,</span> <span class=\"n\">density</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"o\">=</span><span class=\"n\">affine</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Particle Filtering Tractography</span>\n<span class=\"n\">pft_streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">ParticleFilteringTracking</span><span class=\"p\">(</span><span class=\"n\">dg</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">cmc_classifier</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">affine</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">max_cross</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"n\">step_size</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">maxlen</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">pft_back_tracking_dist</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">pft_front_tracking_dist</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">particle_count</span><span class=\"o\">=</span><span class=\"mi\">15</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">return_all</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># streamlines = list(pft_streamline_generator)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">pft_streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"s2\">&quot;pft_streamline.trk&quot;</span><span class=\"p\">,</span> <span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">shape</span><span class=\"p\">)</span>\n\n\n<span class=\"n\">renderer</span><span class=\"o\">.</span><span class=\"n\">clear</span><span class=\"p\">()</span>\n<span class=\"n\">renderer</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n<span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">renderer</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;pft_streamlines.png&#39;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">600</span><span class=\"p\">,</span> <span class=\"mi\">600</span><span class=\"p\">))</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id4\">\n<img alt=\"../../_images/pft_streamlines.png\" src=\"../../_images/pft_streamlines.png\" />\n<p class=\"caption\"><span class=\"caption-text\"><strong>Particle Filtering Tractography</strong></span></p>\n</div>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Local Probabilistic Tractography</span>\n<span class=\"n\">prob_streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">dg</span><span class=\"p\">,</span>\n                                          <span class=\"n\">cmc_classifier</span><span class=\"p\">,</span>\n                                          <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                          <span class=\"n\">affine</span><span class=\"p\">,</span>\n                                          <span class=\"n\">max_cross</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n                                          <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"n\">step_size</span><span class=\"p\">,</span>\n                                          <span class=\"n\">maxlen</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span>\n                                          <span class=\"n\">return_all</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n<span class=\"c1\"># streamlines = list(pro)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">prob_streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"s2\">&quot;probabilistic_streamlines.trk&quot;</span><span class=\"p\">,</span> <span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">shape</span><span class=\"p\">)</span>\n\n<span class=\"n\">renderer</span><span class=\"o\">.</span><span class=\"n\">clear</span><span class=\"p\">()</span>\n<span class=\"n\">renderer</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n<span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">renderer</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;probabilistic_streamlines.png&#39;</span><span class=\"p\">,</span>\n              <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">600</span><span class=\"p\">,</span> <span class=\"mi\">600</span><span class=\"p\">))</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id5\">\n<img alt=\"../../_images/probabilistic_streamlines.png\" src=\"../../_images/probabilistic_streamlines.png\" />\n<p class=\"caption\"><span class=\"caption-text\"><strong>Probabilistic Tractography</strong></span></p>\n</div>\n</div>\n<div class=\"section\" id=\"references\">\n<h2>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<table class=\"docutils citation\" frame=\"void\" id=\"girard2014\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\">[Girard2014]</td><td><em>(<a class=\"fn-backref\" href=\"#id1\">1</a>, <a class=\"fn-backref\" href=\"#id2\">2</a>)</em> Girard, G., Whittingstall, K., Deriche, R., &amp; Descoteaux, M.\nTowards quantitative connectivity analysis: reducing tractography biases.\nNeuroImage, 98, 266-278, 2014.</td></tr>\n</tbody>\n</table>\n<table class=\"docutils citation\" frame=\"void\" id=\"smith2012\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\"><a class=\"fn-backref\" href=\"#id3\">[Smith2012]</a></td><td>Smith, R. E., Tournier, J.-D., Calamante, F., &amp; Connelly, A.\nAnatomically-constrained tractography: Improved diffusion MRI\nstreamlines tractography through effective use of anatomical\ninformation. NeuroImage, 63(3), 1924-1938, 2012.</td></tr>\n</tbody>\n</table>\n<div class=\"admonition-example-source-code admonition\">\n<p class=\"first admonition-title\">Example source code</p>\n<p class=\"last\">You can download <a class=\"reference download internal\" href=\"../../_downloads/particle_filtering_fiber_tracking.py\" download=\"\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">the</span> <span class=\"pre\">full</span> <span class=\"pre\">source</span> <span class=\"pre\">code</span> <span class=\"pre\">of</span> <span class=\"pre\">this</span> <span class=\"pre\">example</span></code></a>.\nThis same script is also included in the dipy source distribution under the\n<code class=\"file docutils literal notranslate\"><span class=\"pre\">doc/examples/</span></code> directory.</p>\n</div>\n</div>\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"]], "sourcename": "examples_built/particle_filtering_fiber_tracking.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Particle Filtering Tractography</a><ul>\n<li><a class=\"reference internal\" href=\"#cmc-act-tissue-classifiers\">CMC/ACT Tissue Classifiers</a></li>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/particle_filtering_fiber_tracking", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.11"}