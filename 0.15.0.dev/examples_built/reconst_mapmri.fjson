{"parents": [], "prev": null, "next": null, "title": "Continuous and analytical diffusion signal modelling with MAPMRI", "meta": {}, "body": "<div class=\"section\" id=\"continuous-and-analytical-diffusion-signal-modelling-with-mapmri\">\n<span id=\"example-reconst-mapmri\"></span><h1>Continuous and analytical diffusion signal modelling with MAPMRI<a class=\"headerlink\" href=\"#continuous-and-analytical-diffusion-signal-modelling-with-mapmri\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>We show how to model the diffusion signal as a linear combination\nof continuous functions from the MAPMRI basis <a class=\"reference internal\" href=\"#ozarslan2013\" id=\"id1\">[Ozarslan2013]</a>.\nThis continuous representation allows for the computation of many\nproperties of both the signal and diffusion propagator.</p>\n<p>We show how to estimate the analytical Orientation Distribution\nFunction (ODF) and a variety of scalar indices. These include rotationally\ninvariant quantities such as the Mean Squared Displacement (MSD), Q-space\nInverse Variance (QIV), Return-To-Origin Probability (RTOP) and\nNon-Gaussianity (NG). Interestingly, the MAP-MRI basis also allows for\nthe computation of directional indices, such as the Return To the Axis\nProbability (RTAP), the Return To the Plane Probability (RTPP), and\nthe parallel and perpendicular Non-Gaussianity.</p>\n<p>The estimation of these properties from noisy DWIs requires that the\nfitting of the MAPMRI basis is regularized. We will show that this can\nbe done using both constraining the diffusion propagator to positive\nvalues <a class=\"reference internal\" href=\"#ozarslan2013\" id=\"id2\">[Ozarslan2013]</a> and analytic Laplacian Regularization (MAPL)\n<a class=\"reference internal\" href=\"#fick2016a\" id=\"id3\">[Fick2016a]</a>.</p>\n<p>First import the necessary modules:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst</span> <span class=\"k\">import</span> <span class=\"n\">mapmri</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"k\">import</span> <span class=\"n\">window</span><span class=\"p\">,</span> <span class=\"n\">actor</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"k\">import</span> <span class=\"n\">fetch_cfin_multib</span><span class=\"p\">,</span> <span class=\"n\">read_cfin_dwi</span><span class=\"p\">,</span> <span class=\"n\">get_sphere</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.core.gradients</span> <span class=\"k\">import</span> <span class=\"n\">gradient_table</span>\n<span class=\"kn\">import</span> <span class=\"nn\">matplotlib.pyplot</span> <span class=\"k\">as</span> <span class=\"nn\">plt</span>\n<span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n<span class=\"kn\">from</span> <span class=\"nn\">mpl_toolkits.axes_grid1</span> <span class=\"k\">import</span> <span class=\"n\">make_axes_locatable</span>\n</pre></div>\n</div>\n<p>Download and read the data for this tutorial.</p>\n<p>MAPMRI requires multi-shell data, to properly fit the radial part of the basis.\nto <code class=\"docutils literal notranslate\"><span class=\"pre\">False</span></code> to only download eddy-current/motion corrected data.\nThe total size of the downloaded data is 187.66 MBytes, however you only need\nto fetch it once.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fetch_cfin_multib</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<p><code class=\"docutils literal notranslate\"><span class=\"pre\">data</span></code> contains the voxel data and <code class=\"docutils literal notranslate\"><span class=\"pre\">gtab</span></code> contains a <code class=\"docutils literal notranslate\"><span class=\"pre\">GradientTable</span></code>\nobject (gradient information e.g. b-values). For example, to show the b-values\nit is possible to write:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"o\">.</span><span class=\"n\">bvals</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>For the values of the q-space indices to make sense it is necessary to\nexplicitly state the <code class=\"docutils literal notranslate\"><span class=\"pre\">big_delta</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">small_delta</span></code> parameters in the\ngradient table.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">img</span><span class=\"p\">,</span> <span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">read_cfin_dwi</span><span class=\"p\">()</span>\n<span class=\"n\">big_delta</span> <span class=\"o\">=</span> <span class=\"mf\">0.0365</span>  <span class=\"c1\"># seconds</span>\n<span class=\"n\">small_delta</span> <span class=\"o\">=</span> <span class=\"mf\">0.0157</span>  <span class=\"c1\"># seconds</span>\n<span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">gradient_table</span><span class=\"p\">(</span><span class=\"n\">bvals</span><span class=\"o\">=</span><span class=\"n\">gtab</span><span class=\"o\">.</span><span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span><span class=\"o\">=</span><span class=\"n\">gtab</span><span class=\"o\">.</span><span class=\"n\">bvecs</span><span class=\"p\">,</span>\n                      <span class=\"n\">big_delta</span><span class=\"o\">=</span><span class=\"n\">big_delta</span><span class=\"p\">,</span>\n                      <span class=\"n\">small_delta</span><span class=\"o\">=</span><span class=\"n\">small_delta</span><span class=\"p\">)</span>\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">img</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">()</span>\n<span class=\"n\">data_small</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">40</span><span class=\"p\">:</span><span class=\"mi\">65</span><span class=\"p\">,</span> <span class=\"mi\">50</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">]</span>\n\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;data.shape (</span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">)&#39;</span> <span class=\"o\">%</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The MAPMRI Model can now be instantiated. The <code class=\"docutils literal notranslate\"><span class=\"pre\">radial_order</span></code> determines the\nexpansion order of the basis, i.e., how many basis functions are used to\napproximate the signal.</p>\n<p>First, we must decide to use the anisotropic or isotropic MAPMRI basis. As was\nshown in <a class=\"reference internal\" href=\"#fick2016a\" id=\"id4\">[Fick2016a]</a>, the isotropic basis is best used for tractography\npurposes, as the anisotropic basis has a bias towards smaller crossing angles\nin the ODF. For signal fitting and estimation of scalar quantities the\nanisotropic basis is suggested. The choice can be made by setting\n<code class=\"docutils literal notranslate\"><span class=\"pre\">anisotropic_scaling=True</span></code> or <code class=\"docutils literal notranslate\"><span class=\"pre\">anisotropic_scaling=False</span></code>.</p>\n<p>First, we must select the method of regularization and/or constraining the\nbasis fitting.</p>\n<ul>\n<li><p class=\"first\"><code class=\"docutils literal notranslate\"><span class=\"pre\">laplacian_regularization=True</span></code> makes it use Laplacian regularization\n<a class=\"reference internal\" href=\"#fick2016a\" id=\"id5\">[Fick2016a]</a>. This method essentially reduces spurious oscillations in the\nreconstruction by minimizing the Laplacian of the fitted signal.\nSeveral options can be given to select the regularization weight:</p>\n<blockquote>\n<div><ul class=\"simple\">\n<li><code class=\"docutils literal notranslate\"><span class=\"pre\">regularization_weighting=GCV</span></code> uses generalized cross-validation\n<a class=\"reference internal\" href=\"#craven1978\" id=\"id6\">[Craven1978]</a> to find an optimal weight.</li>\n<li><code class=\"docutils literal notranslate\"><span class=\"pre\">regularization_weighting=0.2</span></code> for example would omit the GCV and\njust set it to 0.2 (found to be reasonable in HCP data <a class=\"reference internal\" href=\"#fick2016a\" id=\"id7\">[Fick2016a]</a>).</li>\n<li><code class=\"docutils literal notranslate\"><span class=\"pre\">regularization_weighting=np.array(weights)</span></code> would make the GCV use\na custom range to find an optimal weight.</li>\n</ul>\n</div></blockquote>\n</li>\n<li><p class=\"first\"><code class=\"docutils literal notranslate\"><span class=\"pre\">positivity_constraint=True</span></code> makes it use the positivity constraint on the\ndiffusion propagator <a class=\"reference internal\" href=\"#ozarslan2013\" id=\"id8\">[Ozarslan2013]</a>. This method constrains the final\nsolution of the diffusion propagator to be positive at a set of discrete\npoints, since negative values should not exist.</p>\n<blockquote>\n<div><ul class=\"simple\">\n<li>The <code class=\"docutils literal notranslate\"><span class=\"pre\">pos_grid</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">pos_radius</span></code> affect the location and number of\nconstraint points in the diffusion propagator.</li>\n</ul>\n</div></blockquote>\n</li>\n</ul>\n<p>Both methods do a good job of producing viable solutions to the signal fitting\nin practice. The difference is that the Laplacian regularization imposes\nsmoothness over the entire signal, including the extrapolation beyond the\nmeasured signal. In practice this results in, but does not guarantee positive\nsolutions of the diffusion propagator. The positivity constraint guarantees a\npositive solution in a set of discrete points, which in general results in\nsmooth solutions, but does not guarantee it.</p>\n<p>A suggested strategy is to use a low Laplacian weight together with the\npositivity constraint. In this way both desired properties are guaranteed in\nthe final solution.</p>\n<p>We use package CVXPY (<a class=\"reference external\" href=\"http://www.cvxpy.org/\">http://www.cvxpy.org/</a>) to solve convex optimization\nproblems when \u201cpositivity_constraint=True\u201d, so we need to first install\nCVXPY.</p>\n<p>For now we will generate the anisotropic models for all combinations.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">radial_order</span> <span class=\"o\">=</span> <span class=\"mi\">6</span>\n<span class=\"n\">map_model_laplacian_aniso</span> <span class=\"o\">=</span> <span class=\"n\">mapmri</span><span class=\"o\">.</span><span class=\"n\">MapmriModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">radial_order</span><span class=\"o\">=</span><span class=\"n\">radial_order</span><span class=\"p\">,</span>\n                                               <span class=\"n\">laplacian_regularization</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                                               <span class=\"n\">laplacian_weighting</span><span class=\"o\">=.</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n\n<span class=\"n\">map_model_positivity_aniso</span> <span class=\"o\">=</span> <span class=\"n\">mapmri</span><span class=\"o\">.</span><span class=\"n\">MapmriModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span>\n                                                <span class=\"n\">radial_order</span><span class=\"o\">=</span><span class=\"n\">radial_order</span><span class=\"p\">,</span>\n                                                <span class=\"n\">laplacian_regularization</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n                                                <span class=\"n\">positivity_constraint</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n<span class=\"n\">map_model_both_aniso</span> <span class=\"o\">=</span> <span class=\"n\">mapmri</span><span class=\"o\">.</span><span class=\"n\">MapmriModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">radial_order</span><span class=\"o\">=</span><span class=\"n\">radial_order</span><span class=\"p\">,</span>\n                                          <span class=\"n\">laplacian_regularization</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                                          <span class=\"n\">laplacian_weighting</span><span class=\"o\">=.</span><span class=\"mi\">05</span><span class=\"p\">,</span>\n                                          <span class=\"n\">positivity_constraint</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Note that when we use only Laplacian regularization, the <code class=\"docutils literal notranslate\"><span class=\"pre\">GCV</span></code> option may\nselect very low regularization weights in very anisotropic white matter such\nas the corpus callosum, resulting in corrupted scalar indices. In this example\nwe therefore choose a preset value of 0.2, which has shown to be quite robust\nand also faster in practice <a class=\"reference internal\" href=\"#fick2016a\" id=\"id9\">[Fick2016a]</a>.</p>\n<p>We can then fit the MAPMRI model to the data:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">mapfit_laplacian_aniso</span> <span class=\"o\">=</span> <span class=\"n\">map_model_laplacian_aniso</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">)</span>\n<span class=\"n\">mapfit_positivity_aniso</span> <span class=\"o\">=</span> <span class=\"n\">map_model_positivity_aniso</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">)</span>\n<span class=\"n\">mapfit_both_aniso</span> <span class=\"o\">=</span> <span class=\"n\">map_model_both_aniso</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>From the fitted models we will first illustrate the estimation of q-space\nindices. For completeness, we will compare the estimation using only Laplacian\nregularization, positivity constraint or both. We first show the RTOP\n<a class=\"reference internal\" href=\"#ozarslan2013\" id=\"id10\">[Ozarslan2013]</a>.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># generating RTOP plots</span>\n<span class=\"n\">fig</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">figure</span><span class=\"p\">(</span><span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">))</span>\n<span class=\"n\">ax1</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;RTOP - Laplacian&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">rtop_laplacian</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_laplacian_aniso</span><span class=\"o\">.</span><span class=\"n\">rtop</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span>\n                          <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">rtop_laplacian</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax2</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;RTOP - Positivity&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">rtop_positivity</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_positivity_aniso</span><span class=\"o\">.</span><span class=\"n\">rtop</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span>\n                           <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">rtop_positivity</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax3</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;RTOP - Both&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">rtop_both</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_both_aniso</span><span class=\"o\">.</span><span class=\"n\">rtop</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">rtop_both</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">divider</span> <span class=\"o\">=</span> <span class=\"n\">make_axes_locatable</span><span class=\"p\">(</span><span class=\"n\">ax3</span><span class=\"p\">)</span>\n<span class=\"n\">cax</span> <span class=\"o\">=</span> <span class=\"n\">divider</span><span class=\"o\">.</span><span class=\"n\">append_axes</span><span class=\"p\">(</span><span class=\"s2\">&quot;right&quot;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"s2\">&quot;5%&quot;</span><span class=\"p\">,</span> <span class=\"n\">pad</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">cax</span><span class=\"o\">=</span><span class=\"n\">cax</span><span class=\"p\">)</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;MAPMRI_maps_regularization.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\">\n<img alt=\"../../_images/MAPMRI_maps_regularization.png\" src=\"../../_images/MAPMRI_maps_regularization.png\" />\n</div>\n<p>It can be seen that all maps appear quite smooth and similar. Though, it is\npossible to see some subtle differences near the corpus callosum. The\nsimilarity and differences in reconstruction can be further illustrated by\nvisualizing the analytic norm of the Laplacian of the fitted signal.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fig</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">figure</span><span class=\"p\">(</span><span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">))</span>\n<span class=\"n\">ax1</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;Laplacian norm - Laplacian&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">laplacian_norm_laplacian</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_laplacian_aniso</span><span class=\"o\">.</span><span class=\"n\">norm_of_laplacian_signal</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span>\n                <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">laplacian_norm_laplacian</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">3</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax2</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;Laplacian norm - Positivity&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">laplacian_norm_positivity</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_positivity_aniso</span><span class=\"o\">.</span><span class=\"n\">norm_of_laplacian_signal</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span>\n                <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">laplacian_norm_positivity</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">3</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax3</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;Laplacian norm - Both&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">laplacian_norm_both</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_both_aniso</span><span class=\"o\">.</span><span class=\"n\">norm_of_laplacian_signal</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span>\n                <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">laplacian_norm_both</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">3</span><span class=\"p\">)</span>\n<span class=\"n\">divider</span> <span class=\"o\">=</span> <span class=\"n\">make_axes_locatable</span><span class=\"p\">(</span><span class=\"n\">ax3</span><span class=\"p\">)</span>\n<span class=\"n\">cax</span> <span class=\"o\">=</span> <span class=\"n\">divider</span><span class=\"o\">.</span><span class=\"n\">append_axes</span><span class=\"p\">(</span><span class=\"s2\">&quot;right&quot;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"s2\">&quot;5%&quot;</span><span class=\"p\">,</span> <span class=\"n\">pad</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">cax</span><span class=\"o\">=</span><span class=\"n\">cax</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;MAPMRI_norm_laplacian.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\">\n<img alt=\"../../_images/MAPMRI_norm_laplacian.png\" src=\"../../_images/MAPMRI_norm_laplacian.png\" />\n</div>\n<p>A high Laplacian norm indicates that the gradient in the three-dimensional\nsignal reconstruction changes a lot - something that may indicate spurious\noscillations. In the Laplacian reconstruction (left) we see that there are some\nisolated voxels that have a higher norm than the rest. In the\npositivity constraint reconstruction the norm is already smoother. When both\nmethods are used together the overall norm gets smoother still, since both\nsmoothness of the signal and positivity of the propagator are imposed.</p>\n<p>From now on we just use the combined approach, show all maps we can generate\nand explain their significance.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fig</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">figure</span><span class=\"p\">(</span><span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">15</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">))</span>\n<span class=\"n\">ax1</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;MSD&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">msd</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_both_aniso</span><span class=\"o\">.</span><span class=\"n\">msd</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">msd</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax2</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;QIV&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">qiv</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_both_aniso</span><span class=\"o\">.</span><span class=\"n\">qiv</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">qiv</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax3</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;RTOP&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">rtop</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">((</span><span class=\"n\">mapfit_both_aniso</span><span class=\"o\">.</span><span class=\"n\">rtop</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:])</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">rtop</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax4</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;RTAP&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax4</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">rtap</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">((</span><span class=\"n\">mapfit_both_aniso</span><span class=\"o\">.</span><span class=\"n\">rtap</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:])</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax4</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">rtap</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax5</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;RTPP&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax5</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">rtpp</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_both_aniso</span><span class=\"o\">.</span><span class=\"n\">rtpp</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax5</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">rtpp</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;MAPMRI_maps.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\">\n<img alt=\"../../_images/MAPMRI_maps.png\" src=\"../../_images/MAPMRI_maps.png\" />\n</div>\n<p>From left to right:</p>\n<ul class=\"simple\">\n<li>Mean Squared Displacement (MSD) is a measure for how far protons are able to\ndiffuse. a decrease in MSD indicates protons are hindered/restricted more,\nas can be seen by the high MSD in the CSF, but low in the white matter.</li>\n<li>Q-space Inverse Variance (QIV) is a measure of variance in the signal, which\nis said to have higher contrast to white matter than the MSD\n<a class=\"reference internal\" href=\"#hosseinbor2013\" id=\"id11\">[Hosseinbor2013]</a>. We also showed that QIV has high sensitivity to tissue\ncomposition change in a simulation study <a class=\"reference internal\" href=\"#fick2016b\" id=\"id12\">[Fick2016b]</a>.</li>\n<li>Return to origin probability (RTOP) quantifies the probability that a proton\nwill be at the same position at the first and second diffusion gradient\npulse. A higher RTOP indicates that the volume a spin is inside of is\nsmaller, meaning more overall restriction. This is illustrated by the low\nvalues in CSF and high values in white matter.</li>\n<li>Return to axis probability (RTAP) is a directional index that quantifies\nthe probability that a proton will be along the axis of the main eigenvector\nof a diffusion tensor during both diffusion gradient pulses. RTAP has been\nrelated to the apparent axon diameter <a class=\"reference internal\" href=\"#ozarslan2013\" id=\"id13\">[Ozarslan2013]</a> <a class=\"reference internal\" href=\"#fick2016a\" id=\"id14\">[Fick2016a]</a> under\nseveral strong assumptions on the tissue composition and acquisition\nprotocol.</li>\n<li>Return to plane probability (RTPP) is a directional index that quantifies the\nprobability that a proton will be on the plane perpendicular to the main\neigenvector of a diffusion tensor during both gradient pulses. RTPP is\nrelated to the length of a pore <a class=\"reference internal\" href=\"#ozarslan2013\" id=\"id15\">[Ozarslan2013]</a> but in practice should be\nsimilar to that of Gaussian diffusion.</li>\n</ul>\n<p>It is also possible to estimate the amount of non-Gaussian diffusion in every\nvoxel <a class=\"reference internal\" href=\"#ozarslan2013\" id=\"id16\">[Ozarslan2013]</a>. This quantity is estimated through the ratio between\nGaussian volume (MAPMRI\u2019s first basis function) and the non-Gaussian volume\n(all other basis functions) of the fitted signal. For this value to be\nphysically meaningful we must use a b-value threshold in the MAPMRI model. This\nthreshold makes the scale estimation in MAPMRI only use samples that\nrealistically describe Gaussian diffusion, i.e., at low b-values.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">map_model_both_ng</span> <span class=\"o\">=</span> <span class=\"n\">mapmri</span><span class=\"o\">.</span><span class=\"n\">MapmriModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">radial_order</span><span class=\"o\">=</span><span class=\"n\">radial_order</span><span class=\"p\">,</span>\n                                       <span class=\"n\">laplacian_regularization</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                                       <span class=\"n\">laplacian_weighting</span><span class=\"o\">=.</span><span class=\"mi\">05</span><span class=\"p\">,</span>\n                                       <span class=\"n\">positivity_constraint</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                                       <span class=\"n\">bval_threshold</span><span class=\"o\">=</span><span class=\"mi\">2000</span><span class=\"p\">)</span>\n\n<span class=\"n\">mapfit_both_ng</span> <span class=\"o\">=</span> <span class=\"n\">map_model_both_ng</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">)</span>\n\n<span class=\"n\">fig</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">figure</span><span class=\"p\">(</span><span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">))</span>\n<span class=\"n\">ax1</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;NG&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">ng</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_both_ng</span><span class=\"o\">.</span><span class=\"n\">ng</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax1</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">ng</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">divider</span> <span class=\"o\">=</span> <span class=\"n\">make_axes_locatable</span><span class=\"p\">(</span><span class=\"n\">ax1</span><span class=\"p\">)</span>\n<span class=\"n\">cax</span> <span class=\"o\">=</span> <span class=\"n\">divider</span><span class=\"o\">.</span><span class=\"n\">append_axes</span><span class=\"p\">(</span><span class=\"s2\">&quot;right&quot;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"s2\">&quot;5%&quot;</span><span class=\"p\">,</span> <span class=\"n\">pad</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">cax</span><span class=\"o\">=</span><span class=\"n\">cax</span><span class=\"p\">)</span>\n\n\n<span class=\"n\">ax2</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;NG perpendicular&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">ng_perpendicular</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_both_ng</span><span class=\"o\">.</span><span class=\"n\">ng_perpendicular</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span>\n                            <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax2</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">ng_perpendicular</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">divider</span> <span class=\"o\">=</span> <span class=\"n\">make_axes_locatable</span><span class=\"p\">(</span><span class=\"n\">ax2</span><span class=\"p\">)</span>\n<span class=\"n\">cax</span> <span class=\"o\">=</span> <span class=\"n\">divider</span><span class=\"o\">.</span><span class=\"n\">append_axes</span><span class=\"p\">(</span><span class=\"s2\">&quot;right&quot;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"s2\">&quot;5%&quot;</span><span class=\"p\">,</span> <span class=\"n\">pad</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">cax</span><span class=\"o\">=</span><span class=\"n\">cax</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax3</span> <span class=\"o\">=</span> <span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">add_subplot</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"n\">title</span><span class=\"o\">=</span><span class=\"sa\">r</span><span class=\"s1\">&#39;NG parallel&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">set_axis_off</span><span class=\"p\">()</span>\n<span class=\"n\">ng_parallel</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">(</span><span class=\"n\">mapfit_both_ng</span><span class=\"o\">.</span><span class=\"n\">ng_parallel</span><span class=\"p\">()[:,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"p\">:]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">float</span><span class=\"p\">)</span>\n<span class=\"n\">ind</span> <span class=\"o\">=</span> <span class=\"n\">ax3</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">ng_parallel</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                 <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">cm</span><span class=\"o\">.</span><span class=\"n\">gray</span><span class=\"p\">)</span>\n<span class=\"n\">divider</span> <span class=\"o\">=</span> <span class=\"n\">make_axes_locatable</span><span class=\"p\">(</span><span class=\"n\">ax3</span><span class=\"p\">)</span>\n<span class=\"n\">cax</span> <span class=\"o\">=</span> <span class=\"n\">divider</span><span class=\"o\">.</span><span class=\"n\">append_axes</span><span class=\"p\">(</span><span class=\"s2\">&quot;right&quot;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"s2\">&quot;5%&quot;</span><span class=\"p\">,</span> <span class=\"n\">pad</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">(</span><span class=\"n\">ind</span><span class=\"p\">,</span> <span class=\"n\">cax</span><span class=\"o\">=</span><span class=\"n\">cax</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;MAPMRI_ng.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\">\n<img alt=\"../../_images/MAPMRI_ng.png\" src=\"../../_images/MAPMRI_ng.png\" />\n</div>\n<p>On the left we see the overall NG and on the right the directional\nperpendicular NG and parallel NG. The NG ranges from 1 (completely\nnon-Gaussian) to 0 (completely Gaussian). The overall NG of a voxel is always\nhigher or equal than each of its components. It can be seen that NG has low\nvalues in the CSF and higher in the white matter.</p>\n<p>Increases or decreases in these values do not point to a specific\nmicrostructural change, but can indicate clues as to what is happening, similar\nto Fractional Anisotropy. An initial simulation study that quantifies the added\nvalue of q-space indices over DTI indices is given in <a class=\"reference internal\" href=\"#fick2016b\" id=\"id17\">[Fick2016b]</a>.</p>\n<p>The MAPMRI framework also allows for the estimation of Orientation Distribution\nFunctions (ODFs). We recommend to use the isotropic implementation for this\npurpose, as the anisotropic implementation has a bias towards smaller crossing\nangles.</p>\n<p>For the isotropic basis we recommend to use a <code class=\"docutils literal notranslate\"><span class=\"pre\">radial_order</span></code> of 8, as the\nbasis needs more generic and needs more basis functions to approximate the\nsignal.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">radial_order</span> <span class=\"o\">=</span> <span class=\"mi\">8</span>\n<span class=\"n\">map_model_both_iso</span> <span class=\"o\">=</span> <span class=\"n\">mapmri</span><span class=\"o\">.</span><span class=\"n\">MapmriModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">radial_order</span><span class=\"o\">=</span><span class=\"n\">radial_order</span><span class=\"p\">,</span>\n                                        <span class=\"n\">laplacian_regularization</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                                        <span class=\"n\">laplacian_weighting</span><span class=\"o\">=.</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n                                        <span class=\"n\">positivity_constraint</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                                        <span class=\"n\">anisotropic_scaling</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n\n<span class=\"n\">mapfit_both_iso</span> <span class=\"o\">=</span> <span class=\"n\">map_model_both_iso</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Load an ODF reconstruction sphere</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">sphere</span> <span class=\"o\">=</span> <span class=\"n\">get_sphere</span><span class=\"p\">(</span><span class=\"s1\">&#39;symmetric724&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Compute the ODFs.</p>\n<p>The radial order <code class=\"docutils literal notranslate\"><span class=\"pre\">s</span></code> can be increased to sharpen the results, but it might\nalso make the ODFs noisier. Always check the results visually.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">odf</span> <span class=\"o\">=</span> <span class=\"n\">mapfit_both_iso</span><span class=\"o\">.</span><span class=\"n\">odf</span><span class=\"p\">(</span><span class=\"n\">sphere</span><span class=\"p\">,</span> <span class=\"n\">s</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;odf.shape (</span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">)&#39;</span> <span class=\"o\">%</span> <span class=\"n\">odf</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Display the ODFs.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Enables/disables interactive visualization</span>\n<span class=\"n\">interactive</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n<span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Renderer</span><span class=\"p\">()</span>\n<span class=\"n\">sfu</span> <span class=\"o\">=</span> <span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">odf_slicer</span><span class=\"p\">(</span><span class=\"n\">odf</span><span class=\"p\">,</span> <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">sphere</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">=</span><span class=\"s1\">&#39;plasma&#39;</span><span class=\"p\">,</span> <span class=\"n\">scale</span><span class=\"o\">=</span><span class=\"mf\">0.5</span><span class=\"p\">)</span>\n<span class=\"n\">sfu</span><span class=\"o\">.</span><span class=\"n\">display</span><span class=\"p\">(</span><span class=\"n\">y</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"n\">sfu</span><span class=\"o\">.</span><span class=\"n\">RotateX</span><span class=\"p\">(</span><span class=\"o\">-</span><span class=\"mi\">90</span><span class=\"p\">)</span>\n<span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">sfu</span><span class=\"p\">)</span>\n<span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;odfs.png&#39;</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">600</span><span class=\"p\">,</span> <span class=\"mi\">600</span><span class=\"p\">))</span>\n<span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id19\">\n<img alt=\"../../_images/odfs.png\" src=\"../../_images/odfs.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Orientation distribution functions (ODFs).</span></p>\n</div>\n<div class=\"section\" id=\"references\">\n<h2>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this headline\">\u00b6</a></h2>\n<table class=\"docutils citation\" frame=\"void\" id=\"ozarslan2013\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\">[Ozarslan2013]</td><td><em>(<a class=\"fn-backref\" href=\"#id1\">1</a>, <a class=\"fn-backref\" href=\"#id2\">2</a>, <a class=\"fn-backref\" href=\"#id8\">3</a>, <a class=\"fn-backref\" href=\"#id10\">4</a>, <a class=\"fn-backref\" href=\"#id13\">5</a>, <a class=\"fn-backref\" href=\"#id15\">6</a>, <a class=\"fn-backref\" href=\"#id16\">7</a>)</em> Ozarslan E. et al., \u201cMean apparent propagator (MAP) MRI: A\nnovel diffusion imaging method for mapping tissue microstructure\u201d,\nNeuroImage, 2013.</td></tr>\n</tbody>\n</table>\n<table class=\"docutils citation\" frame=\"void\" id=\"fick2016a\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\">[Fick2016a]</td><td><em>(<a class=\"fn-backref\" href=\"#id3\">1</a>, <a class=\"fn-backref\" href=\"#id4\">2</a>, <a class=\"fn-backref\" href=\"#id5\">3</a>, <a class=\"fn-backref\" href=\"#id7\">4</a>, <a class=\"fn-backref\" href=\"#id9\">5</a>, <a class=\"fn-backref\" href=\"#id14\">6</a>)</em> Fick, Rutger HJ, et al. \u201cMAPL: Tissue microstructure estimation\nusing Laplacian-regularized MAP-MRI and its application to HCP data.\u201d\nNeuroImage (2016).</td></tr>\n</tbody>\n</table>\n<table class=\"docutils citation\" frame=\"void\" id=\"craven1978\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\"><a class=\"fn-backref\" href=\"#id6\">[Craven1978]</a></td><td>Craven et al. \u201cSmoothing Noisy Data with Spline Functions.\u201d\nNUMER MATH 31.4 (1978): 377-403.</td></tr>\n</tbody>\n</table>\n<table class=\"docutils citation\" frame=\"void\" id=\"hosseinbor2013\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\"><a class=\"fn-backref\" href=\"#id11\">[Hosseinbor2013]</a></td><td>Hosseinbor et al. \u201cBessel fourier orientation\nreconstruction (bfor): an analytical diffusion propagator reconstruction\nfor hybrid diffusion imaging and computation of q-space indices. NeuroImage\n64, 650-670.</td></tr>\n</tbody>\n</table>\n<table class=\"docutils citation\" frame=\"void\" id=\"fick2016b\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\">[Fick2016b]</td><td><em>(<a class=\"fn-backref\" href=\"#id12\">1</a>, <a class=\"fn-backref\" href=\"#id17\">2</a>)</em> Fick et al. \u201cA sensitivity analysis of Q-space indices with\nrespect to changes in axonal diameter, dispersion and tissue composition.\nISBI 2016.</td></tr>\n</tbody>\n</table>\n<div class=\"admonition-example-source-code admonition\">\n<p class=\"first admonition-title\">Example source code</p>\n<p class=\"last\">You can download <a class=\"reference download internal\" href=\"../../_downloads/reconst_mapmri.py\" download=\"\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">the</span> <span class=\"pre\">full</span> <span class=\"pre\">source</span> <span class=\"pre\">code</span> <span class=\"pre\">of</span> <span class=\"pre\">this</span> <span class=\"pre\">example</span></code></a>.\nThis same script is also included in the dipy source distribution under the\n<code class=\"file docutils literal notranslate\"><span class=\"pre\">doc/examples/</span></code> directory.</p>\n</div>\n</div>\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"]], "sourcename": "examples_built/reconst_mapmri.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Continuous and analytical diffusion signal modelling with MAPMRI</a><ul>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/reconst_mapmri", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.11"}