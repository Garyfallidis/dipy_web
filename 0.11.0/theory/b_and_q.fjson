{"body": "<div class=\"section\" id=\"diy-stuff-about-b-and-q\">\n<span id=\"b-and-q\"></span><h1>DIY Stuff about b and q<a class=\"headerlink\" href=\"#diy-stuff-about-b-and-q\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>This is a short note to explain the nature of the <code class=\"docutils literal\"><span class=\"pre\">B_matrix</span></code> found in the\nSiemens private (CSA) fields of the DICOM headers of a diffusion weighted\nacquisition.  We trying to explain the relationship between the <code class=\"docutils literal\"><span class=\"pre\">B_matrix</span></code> and\nthe <em>b value</em> and the <em>gradient vector</em>.  The acquisition is made with a planned\n(requested) <img class=\"math\" src=\"../../_images/math/5e87bf41a96deddf6cb485ff530f153f2590e9cc.png\" alt=\"b\"/>-value - say <img class=\"math\" src=\"../../_images/math/bbfcdf58b57a117124971e050f76b2d21adc4fe3.png\" alt=\"b_{req} = 1000\"/>, and with a requested gradient\ndirection <img class=\"math\" src=\"../../_images/math/d160557712681a358a646fe448ccc1f21ceeab7a.png\" alt=\"\\mathbf{g}_{req} = [g_x, g_y, g_z]\"/> (supposedly a unit vector) and\npeak amplitude <img class=\"math\" src=\"../../_images/math/b92c09a649305a0aef3239729d93cdf941e0e5cf.png\" alt=\"G\"/>. When the sequence runs the gradient is modulated by an\namplitude envelope <img class=\"math\" src=\"../../_images/math/abfcd1976a78a2c76100f16ecc23a68b111845b7.png\" alt=\"\\rho(t)\"/> with <img class=\"math\" src=\"../../_images/math/c026cdbdb847d457b821c6542503e412471a45e3.png\" alt=\"\\max |\\rho(t)| = 1\"/> so that the time course\nof the gradient is <img class=\"math\" src=\"../../_images/math/1af8939bbdf85b3c2ab25f0353254f3efbebeb4c.png\" alt=\"G\\rho(t)\\mathbf{g}.\"/> <img class=\"math\" src=\"../../_images/math/b92c09a649305a0aef3239729d93cdf941e0e5cf.png\" alt=\"G\"/> is measured in units of <img class=\"math\" src=\"../../_images/math/5c4f55d1ea034acc5244436e110f747f8a6fb826.png\" alt=\"T\n\\mathrm{mm}^-1.\"/> This leads to an important temporal weighting parameter of the\nacquisition:</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/541ed5eb1af42604e0f9fce7c234a4cf4e49924a.png\" alt=\"R   =  \\int_0^T ( \\int_0^t \\rho ( \\tau ) \\, d{ \\tau } )^2 \\, d{t}.\"/></p>\n</div><p>(See Basser, Matiello and LeBihan, 1994.) Another formulation involves\nthe introduction of <cite>k-space</cite>. In standard in-plane MR image encoding</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/53e89e867092c68d80fef94f74cc74114611518b.png\" alt=\"\\mathbf{k} = \\gamma \\int \\mathbf{g}(t)dt.\"/></p>\n</div><p>For the classical Stejskal and Tanner pulsed gradient spin echo (PGSE)\nparadigm where two rectangular pulses of width <img class=\"math\" src=\"../../_images/math/b35a9439ad8c8657b1b1d792ad5c2d77a52c0aef.png\" alt=\"\\delta\"/> seconds are\nspaced with their onsets <img class=\"math\" src=\"../../_images/math/296ab33356160c5a5d59477d3e898f58888f0bdb.png\" alt=\"\\Delta\"/> seconds apart <img class=\"math\" src=\"../../_images/math/035e6f87ed346d787055620ba3a77d44b6e96e46.png\" alt=\"R = \\Delta\n(\\Delta-\\delta/3)^2.\"/> The units of <img class=\"math\" src=\"../../_images/math/9d86170e7de539c0ff999de09621ee0c7b6c8ed0.png\" alt=\"R\"/> are <img class=\"math\" src=\"../../_images/math/019a7918a356c342c793781b8420c39aeb2a48ae.png\" alt=\"s^3\"/>. The <img class=\"math\" src=\"../../_images/math/5e87bf41a96deddf6cb485ff530f153f2590e9cc.png\" alt=\"b\"/>-matrix has\nentries</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/3b042893019d76d829f8fdde3deca3ddce7f6ba6.png\" alt=\"b_{ij} = \\gamma^2 G^2 g_i g_j R,\"/></p>\n</div><p>where <img class=\"math\" src=\"../../_images/math/0ebb67342b546ca42a1c634b1ef03c893c4cdedb.png\" alt=\"\\gamma\"/> is the gyromagnetic radius (units\n<img class=\"math\" src=\"../../_images/math/34810faa84c74193ed25d9e847e657ea6146ed04.png\" alt=\"\\mathrm{radians}.\\mathrm{seconds}^{-1}.T^{-1}\"/>) and <img class=\"math\" src=\"../../_images/math/a581f053bbfa5115f42c13094857cdd12a37ec49.png\" alt=\"i\"/> and <img class=\"math\" src=\"../../_images/math/d32c78b759903e3f4bd4fd2ce0b86358f7500c5d.png\" alt=\"j\"/> are\naxis direcrtions from <img class=\"math\" src=\"../../_images/math/975c0f20e558a0b09286b055b142fe433bb84f93.png\" alt=\"x,y,z\"/> . The units of the B-matrix are\n<img class=\"math\" src=\"../../_images/math/bcf320a2e58b1f52c592019a2cc2317e03ed1076.png\" alt=\"\\mathrm{radians}^2 . \\mathrm{seconds} .  \\mathrm{mm}^{-2}.\"/></p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/c484587b2af5ea852fa3a47622a830509d6fe1a6.png\" alt=\"\\mathbf{B} = \\gamma^2 G^2 R \\mathbf{g} \\mathbf{g}^T.\"/></p>\n</div><p>The b-value for the acquisition is the trace of <img class=\"math\" src=\"../../_images/math/fb542518f2c3338d27234e14932fd1ab5a311d8b.png\" alt=\"\\mathbf{B}\"/> and is\ngiven by</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/93574a38f4d969236c81a0bf74651acb2c9b68d0.png\" alt=\"b = \\gamma^2 G^2 R \\|\\mathbf{g}\\|^2 = \\gamma^2 G^2 R.\"/></p>\n</div></div>\n<div class=\"section\" id=\"the-b-matrix-and-siemens-dicom\">\n<h1>The B matrix and Siemens DICOM<a class=\"headerlink\" href=\"#the-b-matrix-and-siemens-dicom\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>Though the Stejskal and Tanner formula is available for the classic\nPGSE sequence, a different sequence may be used (e.g. TRSE on Siemens\nTrio), and anyway the ramps up and down on the gradient field will not\nbe rectangular. The Siemens scanner software calculates the actual\nvalues of the <img class=\"math\" src=\"../../_images/math/c0ed827e5788f08b1d6eefce8acb2681c74c38ae.png\" alt=\"b_{ij}\"/> by numerical integration of the formula above\nfor <img class=\"math\" src=\"../../_images/math/9d86170e7de539c0ff999de09621ee0c7b6c8ed0.png\" alt=\"R\"/>. These values are in the form of the 6 &#8216;B-matrix&#8217; values\n<img class=\"math\" src=\"../../_images/math/c579c87770f42fc5f6912bf7c2dcc22622d0c0e5.png\" alt=\"[b_{xx}, b_{xy}, b_{xz}, b_{yy}, b_{yz}, b_{zz}]\"/>.</p>\n<p>In this form they are suitable for use in a least squares estimation of\nthe diffusion tensor via the equations across the set of acquisitions:</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/3b8fb3285982c12c8b8a840787e11e3099859ddd.png\" alt=\"\\log(A(\\mathbf{q})/A(0)) = -(b_{xx}D_{xx} + 2b_{xy}D_{xy} + 2b_{xz}D_{xz} + \\\n   b_{yy}D_{yy} + 2b_{yz}D_{yz} + b_{zz}D_{zz})\"/></p>\n</div><p>The gradient field typically stays in the one gradient direction, in\nthis case the relationship between <img class=\"math\" src=\"../../_images/math/5e87bf41a96deddf6cb485ff530f153f2590e9cc.png\" alt=\"b\"/>, <img class=\"math\" src=\"../../_images/math/44cfef0a87943444f7d88fe77a9df36ba6986b11.png\" alt=\"\\mathbf{g}\"/> and the <img class=\"math\" src=\"../../_images/math/c0ed827e5788f08b1d6eefce8acb2681c74c38ae.png\" alt=\"b_{ij}\"/> is as\nfollows. If we fill out the symmetric B-matrix as:</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/7aac101b25d1ee304994448cbc6977597d8c01a4.png\" alt=\"\\mathbf{B} = \\begin{pmatrix}\n              b_{xx} &amp; b_{yx} &amp; b_{yz}\\\\\n              b_{xy} &amp; b_{yy} &amp; b_{xz}\\\\\n              b_{xz} &amp; b_{yz} &amp; b_{zz}\n              \\end{pmatrix}\"/></p>\n</div><p>then <img class=\"math\" src=\"../../_images/math/fb542518f2c3338d27234e14932fd1ab5a311d8b.png\" alt=\"\\mathbf{B}\"/> is equal to the rank 1 tensor <img class=\"math\" src=\"../../_images/math/f27215cffb142cdb0e894a8f3355f39c459ab8d3.png\" alt=\"\\gamma^2 G^2 R\n\\mathbf{g} \\mathbf{g}^T\"/>. By performing an eigenvalue and\neigenvector decomposition of <img class=\"math\" src=\"../../_images/math/fb542518f2c3338d27234e14932fd1ab5a311d8b.png\" alt=\"\\mathbf{B}\"/> we obtain</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/f64951e00cb594326ba0bc305a8804d59b0aeb7a.png\" alt=\"\\mathbf{B} = \\lambda_1\\mathbf{v}_1\\mathbf{v}_1^T +\n             \\lambda_2\\mathbf{v}_2\\mathbf{v}_2^T +\n             \\lambda_3\\mathbf{v}_3\\mathbf{v}_3^T,\"/></p>\n</div><p>where only one of the <img class=\"math\" src=\"../../_images/math/3b765ea6939f1eba2541e91f870cb3c078aa29be.png\" alt=\"\\lambda_i\"/>, say <img class=\"math\" src=\"../../_images/math/18cbd415b1a8e3f19977c5d04d046d41c585c7de.png\" alt=\"\\lambda_1\"/>, is (effectively)\nnon-zero. (Because the gradient is always a multiple of a constant\ndirection <img class=\"math\" src=\"../../_images/math/fb542518f2c3338d27234e14932fd1ab5a311d8b.png\" alt=\"\\mathbf{B}\"/> is a effectively a rank 1 tensor.) Then\n<img class=\"math\" src=\"../../_images/math/d9204aa93e2a4350ba837a5582e7f7a81213f560.png\" alt=\"\\mathbf{g} = \\pm\\mathbf{v}_1\"/>, and <img class=\"math\" src=\"../../_images/math/26e953acda7b094a1b9cbefe2a36f57fc17e6fcf.png\" alt=\"b = \\gamma^2 G^2 R =\n\\lambda_1\"/>. The <code class=\"docutils literal\"><span class=\"pre\">b-vector</span></code> <img class=\"math\" src=\"../../_images/math/dd6a0c79ee7e76c8e6f1310a5d171d5b3848b685.png\" alt=\"\\mathbf{b}\"/> is given by:</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/539552e85709f03aea7ef55f82dd3502a82427d3.png\" alt=\"\\mathbf{b}_{\\mathrm{actual}} = \\gamma^2 G^2 R \\mathbf{g}_{\\mathrm{actual}}\n = \\lambda_1 \\mathbf{v}_1.\"/></p>\n</div><p>Once we have <img class=\"math\" src=\"../../_images/math/6a08c04337caa3ff668bcf37b77af622667483d3.png\" alt=\"\\mathbf{b}_{actual}\"/> we can calculate <img class=\"math\" src=\"../../_images/math/ca05f221ecc13aa98f74d5bbfa919cbf318722dc.png\" alt=\"b_{actual} =\n\\|\\mathbf{b}_{actual}\\|\"/> and <img class=\"math\" src=\"../../_images/math/9119dff3ba1cb747c340c911bc0d5328c3a03820.png\" alt=\"\\mathbf{g}_{actual} = \\mathbf{b}_{actual}\n/ b_{actual}\"/>. Various sofware packages (e.g. FSL&#8217;s DFT-DTIFIT) expect\nto get N x 3 and N x 1 arrays of <img class=\"math\" src=\"../../_images/math/f403591003ae6162f7ffd9f44294517e9c0ce280.png\" alt=\"\\mathbf{g}_{actual}\"/> (<code class=\"docutils literal\"><span class=\"pre\">bvecs</span></code>) and\n<img class=\"math\" src=\"../../_images/math/2fc19b6a7d99f2137d50a532fe9bc1a48f1364d1.png\" alt=\"b_{actual}\"/> values (<code class=\"docutils literal\"><span class=\"pre\">bvals</span></code>) as their inputs.</p>\n</div>\n<div class=\"section\" id=\"and-what-about-q\">\n<h1>... and what about &#8216;q&#8217;?<a class=\"headerlink\" href=\"#and-what-about-q\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>Callaghan, Eccles and Xia (1988) showed that the signal from the\nnarrow pulse PGSE paradigm measured the Fourier transform of the\ndiffusion displacement propagator. Propagation space is measured in\ndisplacement per unit time <img class=\"math\" src=\"../../_images/math/03c42d4ba7cf6b579b14deb59f45b4a83bab2a5c.png\" alt=\"(\\mathrm{mm}.\\mathrm{seconds}^{-1})\"/>. They\nnamed the reciprocal space <code class=\"docutils literal\"><span class=\"pre\">q-space</span></code> with units of\n<img class=\"math\" src=\"../../_images/math/1ac7c0c2bfefb29835640fb332ea83fe467f1ac2.png\" alt=\"\\mathrm{seconds}.\\mathrm{mm}^{-1}\"/>.</p>\n<div class=\"math\">\n<p><img src=\"../../_images/math/3e3d942a7cefcb32cfaabf212a429336533ecaa2.png\" alt=\"q = \\gamma \\delta G /{2\\pi}\"/></p>\n</div><div class=\"math\">\n<p><img src=\"../../_images/math/689a8eca286de65bf4ce1cc1c07e9fd074c4f195.png\" alt=\"b = 4 \\pi^2 q^2 \\Delta\"/></p>\n</div><p>Diffusion spectroscopy measures signal over a wide range of <img class=\"math\" src=\"../../_images/math/5e87bf41a96deddf6cb485ff530f153f2590e9cc.png\" alt=\"b\"/>-values\n(or <img class=\"math\" src=\"../../_images/math/23f1b45408e5b4130c0f940fcbfcec54492cbdcd.png\" alt=\"q\"/>-values) and diffusion times (<img class=\"math\" src=\"../../_images/math/296ab33356160c5a5d59477d3e898f58888f0bdb.png\" alt=\"\\Delta\"/>) and performs a <img class=\"math\" src=\"../../_images/math/23f1b45408e5b4130c0f940fcbfcec54492cbdcd.png\" alt=\"q\"/>-space\nanalysis (Fourier transform of the diffusion signal decay).</p>\n<p>There remains a bit of mystery as to how <img class=\"math\" src=\"../../_images/math/dd9f8e4fa6ad795780215243cbd5a5719b772ad3.png\" alt=\"\\mathbf{q}\"/> (as a vector in\n<img class=\"math\" src=\"../../_images/math/23f1b45408e5b4130c0f940fcbfcec54492cbdcd.png\" alt=\"q\"/>-space) is specified for other paradigms. We think that (a) it only\nmatters up to a scale factor, and (b) we can loosely identify\n<img class=\"math\" src=\"../../_images/math/dd9f8e4fa6ad795780215243cbd5a5719b772ad3.png\" alt=\"\\mathbf{q}\"/> with <img class=\"math\" src=\"../../_images/math/5cc4203e47af254c17d95657c32bea695033369f.png\" alt=\"b\\mathbf{g}\"/>, where <img class=\"math\" src=\"../../_images/math/44cfef0a87943444f7d88fe77a9df36ba6986b11.png\" alt=\"\\mathbf{g}\"/> is the unit\nvector in the gradient direction.</p>\n</div>\n", "alabaster_version": "0.7.7", "display_toc": true, "title": "DIY Stuff about b and q", "sourcename": "theory/b_and_q.rst.txt", "customsidebar": null, "metatags": "", "current_page_name": "theory/b_and_q", "next": null, "rellinks": [["genindex", "General Index", "I", "index"]], "meta": {}, "parents": [], "sidebars": null, "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">DIY Stuff about b and q</a></li>\n<li><a class=\"reference internal\" href=\"#the-b-matrix-and-siemens-dicom\">The B matrix and Siemens DICOM</a></li>\n<li><a class=\"reference internal\" href=\"#and-what-about-q\">... and what about &#8216;q&#8217;?</a></li>\n</ul>\n", "prev": null, "page_source_suffix": ".rst"}