{"body": "<div class=\"section\" id=\"intravoxel-incoherent-motion\">\n<span id=\"example-reconst-ivim\"></span><h1>Intravoxel incoherent motion<a class=\"headerlink\" href=\"#intravoxel-incoherent-motion\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<p>The intravoxel incoherent motion (IVIM) model describes diffusion\nand perfusion in the signal acquired with a diffusion MRI sequence\nthat contains multiple low b-values. The IVIM model can be understood\nas an adaptation of the work of Stejskal and Tanner <a class=\"reference internal\" href=\"#stejskal65\" id=\"id1\">[Stejskal65]</a>\nin biological tissue, and was proposed by Le Bihan <a class=\"reference internal\" href=\"#lebihan84\" id=\"id2\">[LeBihan84]</a>.\nThe model assumes two compartments: a slow moving compartment,\nwhere particles diffuse in a Brownian fashion as a consequence of thermal\nenergy, and a fast moving compartment (the vascular compartment), where\nblood moves as a consequence of a pressure gradient. In the first compartment,\nthe diffusion coefficient is <img class=\"math\" src=\"../../_images/math/3b307d170d8642eb19768bcd0b3f24ffb780469f.png\" alt=\"\\mathbf{D}\"/> while in the second compartment, a\npseudo diffusion term <img class=\"math\" src=\"../../_images/math/56c1b1d8297485a50c9aae7f3820b6c2211a1c45.png\" alt=\"\\mathbf{D^*}\"/> is introduced that describes the\ndisplacement of the blood elements in an assumed randomly laid out vascular\nnetwork, at the macroscopic level. According to <a class=\"reference internal\" href=\"#lebihan84\" id=\"id3\">[LeBihan84]</a>,\n<img class=\"math\" src=\"../../_images/math/56c1b1d8297485a50c9aae7f3820b6c2211a1c45.png\" alt=\"\\mathbf{D^*}\"/> is greater than <img class=\"math\" src=\"../../_images/math/3b307d170d8642eb19768bcd0b3f24ffb780469f.png\" alt=\"\\mathbf{D}\"/>.</p>\n<p>The IVIM model expresses the MRI signal as follows:</p>\n<blockquote>\n<div><div class=\"math\">\n<p><img src=\"../../_images/math/6631a2a585a37ea5bd3f610fd3f5ba748c33e206.png\" alt=\"S(b)=S_0(fe^{-bD^*}+(1-f)e^{-bD})\"/></p>\n</div></div></blockquote>\n<p>where <img class=\"math\" src=\"../../_images/math/dd6a0c79ee7e76c8e6f1310a5d171d5b3848b685.png\" alt=\"\\mathbf{b}\"/> is the diffusion gradient weighing value (which is dependent\non the measurement parameters), <img class=\"math\" src=\"../../_images/math/8173ffa0ef32b77299ab376a239a802434da1d22.png\" alt=\"\\mathbf{S_{0}}\"/> is the signal in the absence\nof diffusion gradient sensitization, <img class=\"math\" src=\"../../_images/math/0839c47b0d956fddf5e640a26d0f4515123d23e0.png\" alt=\"\\mathbf{f}\"/> is the perfusion\nfraction, <img class=\"math\" src=\"../../_images/math/3b307d170d8642eb19768bcd0b3f24ffb780469f.png\" alt=\"\\mathbf{D}\"/> is the diffusion coefficient and <img class=\"math\" src=\"../../_images/math/56c1b1d8297485a50c9aae7f3820b6c2211a1c45.png\" alt=\"\\mathbf{D^*}\"/> is\nthe pseudo-diffusion constant, due to vascular contributions.</p>\n<p>In the following example we show how to fit the IVIM model on a\ndiffusion-weighteddataset and visualize the diffusion and pseudo\ndiffusion coefficients. First, we import all relevant modules:</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">matplotlib.pyplot</span> <span class=\"k\">as</span> <span class=\"nn\">plt</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.ivim</span> <span class=\"k\">import</span> <span class=\"n\">IvimModel</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data.fetcher</span> <span class=\"k\">import</span> <span class=\"n\">read_ivim</span>\n</pre></div>\n</div>\n<p>We get an IVIM dataset using Dipy&#8217;s data fetcher <code class=\"docutils literal\"><span class=\"pre\">read_ivim</span></code>.\nThis dataset was acquired with 21 b-values in 3 different directions.\nVolumes corresponding to different directions were registered to each\nother, and averaged across directions. Thus, this dataset has 4 dimensions,\nwith the length of the last dimension corresponding to the number\nof b-values. In order to use this model the data should contain signals\nmeasured at 0 bvalue.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">img</span><span class=\"p\">,</span> <span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">read_ivim</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<p>The variable <code class=\"docutils literal\"><span class=\"pre\">img</span></code> contains a <code class=\"docutils literal\"><span class=\"pre\">nibabel</span></code> NIfTI image object (with the data)\nand gtab contains a GradientTable object (information about\nthe gradients e.g. b-values and b-vectors). We get the\ndata from img using <code class=\"docutils literal\"><span class=\"pre\">read_data</span></code>.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">img</span><span class=\"o\">.</span><span class=\"n\">get_data</span><span class=\"p\">()</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s1\">&#39;data.shape (</span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">, </span><span class=\"si\">%d</span><span class=\"s1\">)&#39;</span> <span class=\"o\">%</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The data has 54 slices, with 256-by-256 voxels in each slice. The fourth\ndimension corresponds to the b-values in the gtab. Let us visualize the data\nby taking a slice midway(z=33) at <img class=\"math\" src=\"../../_images/math/be72fa1e6917c721ba925c91cb0e418fc19bf58e.png\" alt=\"\\mathbf{b} = 0\"/>.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">z</span> <span class=\"o\">=</span> <span class=\"mi\">33</span>\n<span class=\"n\">b</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">z</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span>\n           <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">axhline</span><span class=\"p\">(</span><span class=\"n\">y</span><span class=\"o\">=</span><span class=\"mi\">100</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">axvline</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"o\">=</span><span class=\"mi\">170</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s2\">&quot;ivim_data_slice.png&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id5\">\n<img alt=\"../../_images/ivim_data_slice.png\" src=\"../../_images/ivim_data_slice.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Heat map of a slice of data</span></p>\n</div>\n<p>The region around the intersection of the cross-hairs in the figure\ncontains cerebral spinal fluid (CSF), so it so it should have a very high\n<img class=\"math\" src=\"../../_images/math/0839c47b0d956fddf5e640a26d0f4515123d23e0.png\" alt=\"\\mathbf{f}\"/> and <img class=\"math\" src=\"../../_images/math/56c1b1d8297485a50c9aae7f3820b6c2211a1c45.png\" alt=\"\\mathbf{D^*}\"/>, the area between the right and left is white\nmatter so that should be lower, and the region on the right is gray matter\nand CSF. That should give us some contrast to see the values varying across\nthe regions.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">x1</span><span class=\"p\">,</span> <span class=\"n\">x2</span> <span class=\"o\">=</span> <span class=\"mi\">90</span><span class=\"p\">,</span> <span class=\"mi\">155</span>\n<span class=\"n\">y1</span><span class=\"p\">,</span> <span class=\"n\">y2</span> <span class=\"o\">=</span> <span class=\"mi\">90</span><span class=\"p\">,</span> <span class=\"mi\">170</span>\n<span class=\"n\">data_slice</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">x1</span><span class=\"p\">:</span><span class=\"n\">x2</span><span class=\"p\">,</span> <span class=\"n\">y1</span><span class=\"p\">:</span><span class=\"n\">y2</span><span class=\"p\">,</span> <span class=\"n\">z</span><span class=\"p\">,</span> <span class=\"p\">:]</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">x1</span><span class=\"p\">:</span><span class=\"n\">x2</span><span class=\"p\">,</span> <span class=\"n\">y1</span><span class=\"p\">:</span><span class=\"n\">y2</span><span class=\"p\">,</span> <span class=\"n\">z</span><span class=\"p\">,</span> <span class=\"n\">b</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n           <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s2\">&quot;gray&quot;</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s2\">&quot;CSF_slice.png&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id6\">\n<img alt=\"../../_images/CSF_slice.png\" src=\"../../_images/CSF_slice.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Heat map of the CSF slice selected.</span></p>\n</div>\n<p>Now that we have prepared the datasets we can go forward with\nthe ivim fit. Instead of fitting the entire volume, we focus on a\nsmall section of the slice as selected aboove, to fit the IVIM model.\nFirst, we instantiate the Ivim model. Using a two-stage approach: first,\na linear fit used to get quick initial guesses for the parameters\n<img class=\"math\" src=\"../../_images/math/8173ffa0ef32b77299ab376a239a802434da1d22.png\" alt=\"\\mathbf{S_{0}}\"/> and <img class=\"math\" src=\"../../_images/math/3b307d170d8642eb19768bcd0b3f24ffb780469f.png\" alt=\"\\mathbf{D}\"/> by considering b-values greater than\n<code class=\"docutils literal\"><span class=\"pre\">split_b_D</span></code> (default: 400))and assuming a mono-exponential signal. This is\nbased on the assumption that at high b-values the signal can be approximated\nas a mono exponential decay and by taking the logarithm of the signal values\na linear fit can be obtained. Another linear fit for <code class=\"docutils literal\"><span class=\"pre\">S0</span></code> (bvals &lt; <code class=\"docutils literal\"><span class=\"pre\">split_b_S0</span></code>\n(default: 200)) follows and <code class=\"docutils literal\"><span class=\"pre\">f</span></code> is estimated using 1 - S0_prime/S0.\nThen a non-linear least squares fitting is performed to fit D_star and f.\nIf the <cite>two_stage</cite> flag is set to <cite>True</cite> while initializing the model, a final\nnon-linear least squares fitting is performed for all the parameters using Scipy&#8217;s\n<code class=\"docutils literal\"><span class=\"pre\">leastsq</span></code> or <code class=\"docutils literal\"><span class=\"pre\">least_square</span></code> function depending on which Scipy version you are\nusing. All initializations for the model such as <code class=\"docutils literal\"><span class=\"pre\">split_b_D</span></code> are passed while\ncreating the <code class=\"docutils literal\"><span class=\"pre\">IvimModel</span></code>. If you are using Scipy 0.17, you can also set bounds by setting\n<code class=\"docutils literal\"><span class=\"pre\">bounds=([0.,</span> <span class=\"pre\">0.,</span> <span class=\"pre\">0.,</span> <span class=\"pre\">0.],</span> <span class=\"pre\">[np.inf,</span> <span class=\"pre\">1.,</span> <span class=\"pre\">1.,</span> <span class=\"pre\">1.]))</span></code> while initializing\nthe IvimModel. It is recommeded that you upgrade to Scipy 0.17 since\nthe fitting results might at times return values which do not make sense\nphysically. (For example a negative <img class=\"math\" src=\"../../_images/math/0839c47b0d956fddf5e640a26d0f4515123d23e0.png\" alt=\"\\mathbf{f}\"/>)</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">ivimmodel</span> <span class=\"o\">=</span> <span class=\"n\">IvimModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>To fit the model, call the <cite>fit</cite> method and pass the data for fitting.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">ivimfit</span> <span class=\"o\">=</span> <span class=\"n\">ivimmodel</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_slice</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The fit method creates a IvimFit object which contains the\nparameters of the model obtained after fitting. These are accessible\nthrough the <cite>model_params</cite> attribute of the IvimFit object.\nThe parameters are arranged as a 4D array, corresponding to the spatial\ndimensions of the data, and the last dimension (of length 4)\ncorresponding to the model parameters according to the following\norder : <img class=\"math\" src=\"../../_images/math/9577adad9e05038393027a929c3f7097fb8d73bd.png\" alt=\"\\mathbf{S_{0}, f, D^*, D}\"/>.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">ivimparams</span> <span class=\"o\">=</span> <span class=\"n\">ivimfit</span><span class=\"o\">.</span><span class=\"n\">model_params</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;ivimparams.shape : </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">ivimparams</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">))</span>\n</pre></div>\n</div>\n<p>As we see, we have a 20x20 slice at the height z = 33. Thus we\nhave 400 voxels. We will now plot the parameters obtained from the\nfit for a voxel and also various maps for the entire slice.\nThis will give us an idea about the diffusion and perfusion in\nthat section. Let(i, j) denote the coordinate of the voxel. We have\nalready fixed the z component as 33 and hence we will get a slice\nwhich is 33 units above.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">j</span> <span class=\"o\">=</span> <span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"mi\">10</span>\n<span class=\"n\">estimated_params</span> <span class=\"o\">=</span> <span class=\"n\">ivimfit</span><span class=\"o\">.</span><span class=\"n\">model_params</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">j</span><span class=\"p\">,</span> <span class=\"p\">:]</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">estimated_params</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Next, we plot the results relative to the model fit.\nFor this we will use the <cite>predict</cite> method of the IvimFit object\nto get the estimated signal.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">estimated_signal</span> <span class=\"o\">=</span> <span class=\"n\">ivimfit</span><span class=\"o\">.</span><span class=\"n\">predict</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">)[</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">j</span><span class=\"p\">,</span> <span class=\"p\">:]</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">scatter</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"o\">.</span><span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">data_slice</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">j</span><span class=\"p\">,</span> <span class=\"p\">:],</span>\n            <span class=\"n\">color</span><span class=\"o\">=</span><span class=\"s2\">&quot;green&quot;</span><span class=\"p\">,</span> <span class=\"n\">label</span><span class=\"o\">=</span><span class=\"s2\">&quot;Actual signal&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">plot</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"o\">.</span><span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">estimated_signal</span><span class=\"p\">,</span> <span class=\"n\">color</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">,</span> <span class=\"n\">label</span><span class=\"o\">=</span><span class=\"s2\">&quot;Estimated Signal&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">xlabel</span><span class=\"p\">(</span><span class=\"s2\">&quot;bvalues&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">ylabel</span><span class=\"p\">(</span><span class=\"s2\">&quot;Signals&quot;</span><span class=\"p\">)</span>\n\n<span class=\"n\">S0_est</span><span class=\"p\">,</span> <span class=\"n\">f_est</span><span class=\"p\">,</span> <span class=\"n\">D_star_est</span><span class=\"p\">,</span> <span class=\"n\">D_est</span> <span class=\"o\">=</span> <span class=\"n\">estimated_params</span>\n<span class=\"n\">text_fit</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;&quot;Estimated </span><span class=\"se\">\\n</span><span class=\"s2\"> S0=</span><span class=\"si\">{:06.3f}</span><span class=\"s2\"> f=</span><span class=\"si\">{:06.4f}</span><span class=\"se\">\\n</span><span class=\"s2\"></span>\n<span class=\"s2\">            D*=</span><span class=\"si\">{:06.5f}</span><span class=\"s2\"> D=</span><span class=\"si\">{:06.5f}</span><span class=\"s2\">&quot;&quot;&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">S0_est</span><span class=\"p\">,</span> <span class=\"n\">f_est</span><span class=\"p\">,</span> <span class=\"n\">D_star_est</span><span class=\"p\">,</span> <span class=\"n\">D_est</span><span class=\"p\">)</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">text</span><span class=\"p\">(</span><span class=\"mf\">0.65</span><span class=\"p\">,</span> <span class=\"mf\">0.50</span><span class=\"p\">,</span> <span class=\"n\">text_fit</span><span class=\"p\">,</span> <span class=\"n\">horizontalalignment</span><span class=\"o\">=</span><span class=\"s1\">&#39;center&#39;</span><span class=\"p\">,</span>\n         <span class=\"n\">verticalalignment</span><span class=\"o\">=</span><span class=\"s1\">&#39;center&#39;</span><span class=\"p\">,</span> <span class=\"n\">transform</span><span class=\"o\">=</span><span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">gca</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">transAxes</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">legend</span><span class=\"p\">(</span><span class=\"n\">loc</span><span class=\"o\">=</span><span class=\"s1\">&#39;upper right&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s2\">&quot;ivim_voxel_plot.png&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id7\">\n<img alt=\"../../_images/ivim_voxel_plot.png\" src=\"../../_images/ivim_voxel_plot.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Plot of the signal from one voxel.</span></p>\n</div>\n<p>Now we can map the perfusion and diffusion maps for the slice. We\nwill plot a heatmap showing the values using a colormap. It will be\nuseful to define a plotting function for the heatmap here since we\nwill use it to plot for all the IVIM parameters. We will need to specify\nthe lower and upper limits for our data. For example, the perfusion\nfractions should be in the range (0,1). Similarly, the diffusion and\npseudo-diffusion constants are much smaller than 1. We pass an argument\ncalled <code class=\"docutils literal\"><span class=\"pre\">variable</span></code> to out plotting function which gives the label for\nthe plot.</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"k\">def</span> <span class=\"nf\">plot_map</span><span class=\"p\">(</span><span class=\"n\">raw_data</span><span class=\"p\">,</span> <span class=\"n\">variable</span><span class=\"p\">,</span> <span class=\"n\">limits</span><span class=\"p\">,</span> <span class=\"n\">filename</span><span class=\"p\">):</span>\n    <span class=\"n\">lower</span><span class=\"p\">,</span> <span class=\"n\">upper</span> <span class=\"o\">=</span> <span class=\"n\">limits</span>\n    <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">title</span><span class=\"p\">(</span><span class=\"s1\">&#39;Map for </span><span class=\"si\">{}</span><span class=\"s1\">&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">variable</span><span class=\"p\">))</span>\n    <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">raw_data</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">clim</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">lower</span><span class=\"p\">,</span> <span class=\"n\">upper</span><span class=\"p\">),</span>\n               <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s2\">&quot;gray&quot;</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">colorbar</span><span class=\"p\">()</span>\n    <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n    <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n</pre></div>\n</div>\n<p>Let us get the various plots so that we can visualize them in one page</p>\n<div class=\"highlight-default\"><div class=\"highlight\"><pre><span></span><span class=\"n\">plot_map</span><span class=\"p\">(</span><span class=\"n\">ivimfit</span><span class=\"o\">.</span><span class=\"n\">S0_predicted</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Predicted S0&quot;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">10000</span><span class=\"p\">),</span> <span class=\"s2\">&quot;predicted_S0.png&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plot_map</span><span class=\"p\">(</span><span class=\"n\">data_slice</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"s2\">&quot;Measured S0&quot;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">10000</span><span class=\"p\">),</span> <span class=\"s2\">&quot;measured_S0.png&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plot_map</span><span class=\"p\">(</span><span class=\"n\">ivimfit</span><span class=\"o\">.</span><span class=\"n\">perfusion_fraction</span><span class=\"p\">,</span> <span class=\"s2\">&quot;f&quot;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">),</span> <span class=\"s2\">&quot;perfusion_fraction.png&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plot_map</span><span class=\"p\">(</span><span class=\"n\">ivimfit</span><span class=\"o\">.</span><span class=\"n\">D_star</span><span class=\"p\">,</span> <span class=\"s2\">&quot;D*&quot;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mf\">0.01</span><span class=\"p\">),</span> <span class=\"s2\">&quot;perfusion_coeff.png&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">plot_map</span><span class=\"p\">(</span><span class=\"n\">ivimfit</span><span class=\"o\">.</span><span class=\"n\">D</span><span class=\"p\">,</span> <span class=\"s2\">&quot;D&quot;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mf\">0.001</span><span class=\"p\">),</span> <span class=\"s2\">&quot;diffusion_coeff.png&quot;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"figure align-center\" id=\"id8\">\n<img alt=\"../../_images/predicted_S0.png\" src=\"../../_images/predicted_S0.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Heatmap of S0 predicted from the fit</span></p>\n</div>\n<div class=\"figure align-center\" id=\"id9\">\n<img alt=\"../../_images/measured_S0.png\" src=\"../../_images/measured_S0.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Heatmap of measured signal at bvalue = 0.</span></p>\n</div>\n<div class=\"figure align-center\" id=\"id10\">\n<img alt=\"../../_images/perfusion_fraction.png\" src=\"../../_images/perfusion_fraction.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Heatmap of perfusion fraction values predicted from the fit</span></p>\n</div>\n<div class=\"figure align-center\" id=\"id11\">\n<img alt=\"../../_images/perfusion_coeff.png\" src=\"../../_images/perfusion_coeff.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Heatmap of perfusion coefficients predicted from the fit.</span></p>\n</div>\n<div class=\"figure align-center\" id=\"id12\">\n<img alt=\"../../_images/diffusion_coeff.png\" src=\"../../_images/diffusion_coeff.png\" />\n<p class=\"caption\"><span class=\"caption-text\">Heatmap of diffusion coefficients predicted from the fit</span></p>\n</div>\n<p>References:</p>\n<table class=\"docutils citation\" frame=\"void\" id=\"stejskal65\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\"><a class=\"fn-backref\" href=\"#id1\">[Stejskal65]</a></td><td>Stejskal, E. O.; Tanner, J. E. (1 January 1965).\n&#8220;Spin Diffusion Measurements: Spin Echoes in the Presence\nof a Time-Dependent Field Gradient&#8221;. The Journal of Chemical\nPhysics 42 (1): 288. Bibcode: 1965JChPh..42..288S.\ndoi:10.1063/1.1695690.</td></tr>\n</tbody>\n</table>\n<table class=\"docutils citation\" frame=\"void\" id=\"lebihan84\" rules=\"none\">\n<colgroup><col class=\"label\" /><col /></colgroup>\n<tbody valign=\"top\">\n<tr><td class=\"label\">[LeBihan84]</td><td><em>(<a class=\"fn-backref\" href=\"#id2\">1</a>, <a class=\"fn-backref\" href=\"#id3\">2</a>)</em> Le Bihan, Denis, et al. &#8220;Separation of diffusion\nand perfusion in intravoxel incoherent motion MR\nimaging.&#8221; Radiology 168.2 (1988): 497-505.</td></tr>\n</tbody>\n</table>\n<div class=\"admonition-example-source-code admonition\">\n<p class=\"first admonition-title\">Example source code</p>\n<p class=\"last\">You can download <a class=\"reference download internal\" href=\"../../_downloads/reconst_ivim.py\" download=\"\"><code class=\"xref download docutils literal\"><span class=\"pre\">the</span> <span class=\"pre\">full</span> <span class=\"pre\">source</span> <span class=\"pre\">code</span> <span class=\"pre\">of</span> <span class=\"pre\">this</span> <span class=\"pre\">example</span></code></a>.\nThis same script is also included in the dipy source distribution under the\n<code class=\"file docutils literal\"><span class=\"pre\">doc/examples/</span></code> directory.</p>\n</div>\n</div>\n", "alabaster_version": "0.7.7", "display_toc": false, "title": "Intravoxel incoherent motion", "sourcename": "examples_built/reconst_ivim.rst.txt", "customsidebar": null, "metatags": "", "current_page_name": "examples_built/reconst_ivim", "next": null, "rellinks": [["genindex", "General Index", "I", "index"]], "meta": {}, "parents": [], "sidebars": null, "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Intravoxel incoherent motion</a></li>\n</ul>\n", "prev": null, "page_source_suffix": ".rst"}